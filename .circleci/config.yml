version: 2.1
orbs: 
  node: circleci/node@5.0.2
jobs:
  demo-deploy:
    executor: node/default
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Prepare demo directory for deployment
          command: npm run prep-demo
      - run:
          name: Install and configure gh-pages
          command: |
            npm install --silent gh-pages@4
            git config user.email "ci-build@circleci.invalid"
            git config user.name "ci-build"
      - add_ssh_keys:
          fingerprints:
            - "70:23:d1:28:e7:fe:4e:91:15:f7:69:93:3f:38:28:a8"
      - run:
          name: Deploy demo to gh-pages branch
          command: node_modules/.bin/gh-pages --dist demo --message "[skip ci] Update demo page"

workflows:
  build:
    jobs:
      - node/test
      - demo-deploy:
          requires:
            - node/test
          filters:
            branches:
              only: main
